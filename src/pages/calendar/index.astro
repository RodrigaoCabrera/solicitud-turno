---
import Layout from "../../layouts/Layout.astro";
import Cally from "../../components/Cally.tsx";

import { db, ProfessionalProfile, Availability, Appointments } from "astro:db";
import GoBack from "@/astro-components/UI/GoBack.astro";

let professionalData, availability, appointments;

try {
  const [professionalResponse, availabilityResponse, appointmentsResponse] =
    await Promise.all([
      db
        .select({
          id: ProfessionalProfile.id,
          sessionTime: ProfessionalProfile.sessionTime,
          address: ProfessionalProfile.address,
        })
        .from(ProfessionalProfile),
      db.select().from(Availability),
      db.select().from(Appointments),
    ]);

  professionalData = professionalResponse[0];
  availability = availabilityResponse;
  appointments = appointmentsResponse;
} catch (error) {
  console.error("Error fetching data:", error);
  professionalData = null;
  availability = null;
  appointments = null;
}
---

<Layout title="Elegir fecha y hora">
  <GoBack label="Nuevo turno" to="/" />
  {
    professionalData && availability && appointments ? (
      <Cally
        client:only="react"
        professionalData={professionalData}
        availability={availability}
        appointments={appointments}
      />
    ) : (
      <p>Hubo un error al leer los datos.</p>
    )
  }
</Layout>
